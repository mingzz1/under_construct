<!DOCTYPE html>
<html class="no-js">
  <head>
	<meta charset="utf-8">
	<title>[AWS S3] Referer를 통해 S3 파일 접근 제어하기 | mingzzi</title>
	<meta name="description" content="AWS에는 S3(Simple Storage Service)라는 저장소가 존재한다.S3에서는 데이터를 저장하기 위한 기본 컨테이너를 bucket라고 부르는데, 이 bucket에 Referer를 통한 접근제어 정책을 설정 해 특정 도메인에서만 접근할 수 있도록 하는 방법을 정리한다.">

	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no" /> 

	<!-- CSS -->
	<link rel="stylesheet" href="/assets/css/main.css">

	<!--Favicon-->
	<link rel="shortcut icon" href="/assets/favicon.ico" type="image/x-icon">

	<!-- Canonical -->
	<link rel="canonical" href="/pentesting/cloud/2020/04/05/aws_s3_access_control_with_referer.html">

	<!-- RSS -->
	<link rel="alternate" type="application/atom+xml" title="mingzzi" href="/feed.xml" />

	<!-- Font Awesome -->
	<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">

	<!-- Google Fonts -->
	
	<link href="https://fonts.googleapis.com/css?family=Nanum+Gothic:400,700" rel="stylesheet">
	

	<!-- KaTeX -->
	
	<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/KaTeX/0.8.3/katex.min.css">
	<script src="//cdnjs.cloudflare.com/ajax/libs/KaTeX/0.8.3/katex.min.js"></script>
	

	<!-- jquery -->
	<script src="https://code.jquery.com/jquery-1.12.4.min.js" integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin="anonymous"></script>

	<!-- Global site tag (gtag.js) - Google Analytics -->
	<script async src="https://www.googletagmanager.com/gtag/js?id=UA-130304424-1"></script>
	<script>
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());

	gtag('config', 'UA-130304424-1');
	</script>
	
	<!-- Google AdSense -->
	<script data-ad-client="ca-pub-1587587893565234" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
	<script>
		var flag = false;
		$(function() {
			$(".menu_btn").click(function() {
				$(this).toggleClass("on")
				if(flag) {
					$(".cat1").css("display", "none");
					flag = false;
				} else {
					$(".cat1").css("display", "block");
					flag = true;
		
				}
			})
		})
		$(document).ready(function() {
			$(".cat1 li").click(function() {
				$(".sub").hide();
				$("ul", this).slideToggle("fast");
			});
		});

	</script>
</head>

  <header class="site-header">
	<div class="branding">
		
		<a href="/">
			<img class="avatar" src="/assets/img/blogmark.png" alt=""/>
		</a>
		
		<h1 class="site-title">
			<a href="/">mingzzi</a>
		</h1>
		<nav class="site-nav">
				<ul>
					<li> <a class="page-link" href="/about">About</a> </li>					
					<li> <a class="page-link" href="/archive">Archive</a> </li>
					<li> <a class="page-link" href="/tags">Tags</a> </li>

					<!-- Search bar -->
					
					<li>
					<form action="/search.html" method="get">
						<input type="text" id="search-box" name="query" placeholder="Search" class="">
						<button type="submit" class="">
							<i class="fa fa-fw fa-search"></i>
						</button>
					</form>
					</li>
					
				</ul>
		</nav>
	</div>
	
	<div class="menu_btn">
		<span></span>
		<span></span>
		<span></span>
	</div>

	<div class="site-category">
			<ul class='cat1'>
				<li><a href="/">Home</a></li>
				<li><a href="#">Pentesting</a>
					<ul class="sub">
						<li><a href="/Pentest/iOS">iOS</a></li>
						<li><a href="/Pentest/Android">Android</a></li>
						<li><a href="/Pentest/PWeb">Web</a></li>
                                                <li><a href="/Pentest/Cloud">Cloud</a></li>
					</ul>
				</li>

				<li><a href="#">Wargame</a>
					<ul class="sub">
						<li><a href="/Wargame/LoS">Load of SQL Injection</a></li>
						<li><a href="/Wargame/Pwnkr">Pwnable.kr</a></li>
						<li><a href="/Wargame/Warkr">Wargame.kr</a></li>
						<li><a href="/Wargame/XG">XSS Game</a></li>
					</ul>
				</li>

				<li><a href="#">CTF</a>
					<ul class="sub">
						<li><a href="/CTF/2018">2018</a></li>
						<li><a href="/CTF/2019">2019</a></li>
					</ul>
				</li>

				<li><a href="#">Error</a>
					<ul class="sub">
						<li><a href="/Error/Linux">Linux</a></li>
						<li><a href="/Error/Windows">Windows</a></li>
                                                <li><a href="/Error/Python">Python</a></li>
					</ul>
				</li>

				<li><a href="#">Development</a>
					<ul class="sub">
						<li><a href="/Develop/Database">Database</a></li>
						<li><a href="/Develop/Blog">Github Blog</a></li>
						<li><a href="/Develop/DWeb">Web</a></li>
						<li><a href="/Develop/Docker">Docker</a></li>
						<li><a href="/Develop/Basic">Basic</a></li>
						<li><a href="/Develop/SecureCoding">Secure Coding</a></li>
					</ul>
				</li>
			</ul>
		</div>

</header>

  <body>
    <div class="content">
      <article >
  <header style="background-image: url('/')">
    <h1 class="title">[AWS S3] Referer를 통해 S3 파일 접근 제어하기</h1>
    
    <p class="meta">
      April 5, 2020
      
    </p>
  </header>
  <section class="post-content"><p><code class="highlighter-rouge">AWS</code>에는 <code class="highlighter-rouge">S3(Simple Storage Service)</code>라는 저장소가 존재한다.</p>

<p><code class="highlighter-rouge">S3</code>에서는 데이터를 저장하기 위한 기본 컨테이너를 <code class="highlighter-rouge">bucket</code>라고 부르는데, 이 <code class="highlighter-rouge">bucket</code>에 <code class="highlighter-rouge">Referer</code>를 통한 접근제어 정책을 설정 해 특정 도메인에서만 접근할 수 있도록 하는 방법을 정리한다.<br />
<!--more--></p>

<p><code class="highlighter-rouge">S3</code>에서 <code class="highlighter-rouge">bucket</code>을 생성할 때 아무 설정도 건드리지 않는다면 기본적으로 <code class="highlighter-rouge">bucket</code>과 <code class="highlighter-rouge">bucket 내 파일</code>의 접근 권한은 <code class="highlighter-rouge">private</code>이 된다.</p>

<p>하지만 웹에서 사용하는 이미지 등을 <code class="highlighter-rouge">S3</code> 등에 올리며, 설정을 <code class="highlighter-rouge">public</code>으로 바꾸는 경우가 있는 것 같다.</p>

<p><code class="highlighter-rouge">bucket</code>의 접근 권한 설정을 <code class="highlighter-rouge">public</code>으로 할 경우 설정에 따라 임의의 사용자가 파일 업로드 및 다운로드 할 수 있으므로 접근제어 정책을 설정 해 주는 것이 좋다.</p>

<p><code class="highlighter-rouge">S3</code> 페이지에 접속하여 <code class="highlighter-rouge">bucket</code>을 선택한 후, <code class="highlighter-rouge">권한 &gt; 버킷 정책</code>을 선택하면 아래와 같이 <code class="highlighter-rouge">버킷 정책 편집기</code>를 확인할 수 있다.</p>

<p><img src="/images/pen-testing/cloud/s3_referer/bucket_referer_setting_01.png" alt="" /></p>

<p>스크롤을 아래로 내려 보면 <code class="highlighter-rouge">정책 생성기</code>가 있는데, 이를 선택한다.</p>

<p><img src="/images/pen-testing/cloud/s3_referer/bucket_referer_setting_02.png" alt="" /></p>

<p>아래는 <code class="highlighter-rouge">정책 생성기</code>의 기본 페이지 모습이다.</p>

<p>정책을 설정하는 것은 아니고, <code class="highlighter-rouge">버킷 정책 편집기</code>에 들어갈 정책을 <code class="highlighter-rouge">format</code>에 맞게 만들어 주는 페이지이다.</p>

<p>만약 <code class="highlighter-rouge">정책 설정 format</code>을 모두 알고있다면 굳이 <code class="highlighter-rouge">정책 생성기</code>를 사용 할 필요는 없는 것 같다.</p>

<p><img src="/images/pen-testing/cloud/s3_referer/bucket_referer_setting_03.png" alt="" /></p>

<p>정책을 설정하기 위해 아래와 같이 선택한다.</p>

<p><img src="/images/pen-testing/cloud/s3_referer/bucket_referer_setting_04.png" alt="" /></p>

<p><code class="highlighter-rouge">Amazon Resource Name (ARN)</code>은 앞의 <code class="highlighter-rouge">버킷 정책 편집기</code> 페이지에서 확인할 수 있다.</p>

<p><img src="/images/pen-testing/cloud/s3_referer/bucket_referer_setting_05.png" alt="" /></p>

<p>모든 정책을 다 적으면 아래와 같다.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* Effect : Allow
* Principal : *
* AWS Service : Amazon S3
* Actions : GetObject
* Amazon Resource Name (ARN) : [버킷 정책 편집기] 페이지에서 확인한 값/*

&gt; Add Conditions (Optional)
* Condition : StringLike
* Key : aws:Referer
* Value : http://DOMAINNAME/*
</code></pre></div></div>

<p><img src="/images/pen-testing/cloud/s3_referer/bucket_referer_setting_06.png" alt="" /></p>

<p>각 설정에 대한 설명은 다음과 같다.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* Effect : 특정 도메인에 대해 '허용'하는 정책이므로 Allow
* Principal : 정책을 적용할 대상, 웹을 통해 접속하는 모든 사람이 대상이므로 *
* AWS Service : 적용 할 서비스 명
* Actions : 정책이 적용되는 action. S3에서 이미지 파일을 다운로드 하므로 s3:GetObject
* Amazon Resource Name (ARN) : [버킷 정책 편집기] 페이지에서 확인한 값/*

&gt; Add Conditions (Optional)
* Condition : 정책 조건 부여. 특정 도메인을 통할 경우 정책이 적용되어야 하므로 StringLike
* Key : 조건을 어디에 적용할 지. 이 경우 Referer를 통해 확인하므로 aws:Referer
* Value : 허용 할 도메인 값을 입력, http://DOMAINNAME/*
  =&gt; if (Referer == "http://DOMAINNAME/*") 와 같음
</code></pre></div></div>

<blockquote>
  <p><a href="https://ko.wikipedia.org/wiki/HTTP_%EB%A6%AC%ED%8D%BC%EB%9F%AC">HTTP Referer란?</a></p>
  <ul>
    <li>웹 브라우저로 World Wide Web을 서핑할 때 하이퍼링크를 통해 각각의 사이트로 방문 시 남는 흔적</li>
    <li>예를 들어 A 페이지에서 B 사이트로 이동하는 하이퍼링크가 존재 할 경우, 사용자가 이 하이퍼링크를 클릭하면 웹 브라우저에서 B 사이트로 참조 주소(Referer)를 전송함</li>
    <li>B 사이트 관리자는 이 Referer를 통해 방문객이 A 사이트를 통해 자신의 사이트에 방문한 것을 알 수 있음</li>
  </ul>
</blockquote>

<p>모든 설정을 한 후, <code class="highlighter-rouge">Add Condition</code>과 <code class="highlighter-rouge">Add Statement</code>를 차례로 눌러 주면 아래와 같이 정책이 생긴 것을 알 수 있다.</p>

<p>이 후 <code class="highlighter-rouge">Generate Policy</code>를 눌러 준다.</p>

<p><img src="/images/pen-testing/cloud/s3_referer/bucket_referer_setting_07.png" alt="" /></p>

<p>그 결과 아래와 같이 <code class="highlighter-rouge">JSON</code> 형태의 정책을 확인할 수 있다.</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="s2">"Version"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2012-10-17"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"Id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Policy1586072492270"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"Statement"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="s2">"Sid"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Stmt1586072470528"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"Effect"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Allow"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"Principal"</span><span class="p">:</span><span class="w"> </span><span class="s2">"*"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"Action"</span><span class="p">:</span><span class="w"> </span><span class="s2">"s3:GetObject"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"Resource"</span><span class="p">:</span><span class="w"> </span><span class="s2">"arn:aws:s3:::OOOOO-test-bucket1/*"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"Condition"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="s2">"StringLike"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                    </span><span class="s2">"aws:Referer"</span><span class="p">:</span><span class="w"> </span><span class="s2">"http://OOOOO.kr/*"</span><span class="w">
                </span><span class="p">}</span><span class="w">
            </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p><img src="/images/pen-testing/cloud/s3_referer/bucket_referer_setting_08.png" alt="" /></p>

<p>해당 값을 복사한 후 다시 <code class="highlighter-rouge">버킷 정책 편집기</code>로 돌아 와 붙여넣기 한 후, <code class="highlighter-rouge">저장</code> 버튼을 선택하면 정책 설정이 완료된다.</p>

<p><img src="/images/pen-testing/cloud/s3_referer/bucket_referer_setting_09.png" alt="" /></p>

<p>접근 권한을 다시 설정하기 위하여 <code class="highlighter-rouge">권한 &gt; 퍼블릭 액세스 차단</code> 메뉴로 가 아래와 같이 <code class="highlighter-rouge">새 퍼블릭 버킷 또는 액세스 지점 정책을 통해 부여된 버킷 및 객체에 대한 퍼블릭 액세스 차단</code>을 활성화 해 준다.</p>

<p><img src="/images/pen-testing/cloud/s3_referer/bucket_referer_setting_10.png" alt="" /></p>

<p>아래와 같은 확인 창이 뜨면 <code class="highlighter-rouge">확인</code>을 입력하고 <code class="highlighter-rouge">확인</code> 버튼을 눌러주면 된다.</p>

<p><img src="/images/pen-testing/cloud/s3_referer/bucket_referer_setting_11.png" alt="" /></p>

<p>위의 과정이 끝나면 <code class="highlighter-rouge">퍼블랙 액세스 차단</code> 설정이 아래와 같이 설정 된다.</p>

<p><img src="/images/pen-testing/cloud/s3_referer/bucket_referer_setting_12.png" alt="" /></p>

<p>이제 정책이 정상적으로 적용되었는지 확인 해 보면 된다.</p>

<p>나는 <code class="highlighter-rouge">bucket</code>에 <code class="highlighter-rouge">flower.png</code>를 넣어 뒀는데, 해당 이미지에 직접 접근하면 아래와 같이 <code class="highlighter-rouge">AccessDenied</code>가 뜨는 것을 확인할 수 있다.</p>

<p><img src="/images/pen-testing/cloud/s3_referer/bucket_referer_setting_13.png" alt="" /></p>

<p>이에, 내가 설정한 도메인에서 <code class="highlighter-rouge">&lt;img&gt;</code> 태그를 통해 해당 이미지를 불러오면 정상적으로 이미지가 출력된다.</p>

<p><img src="/images/pen-testing/cloud/s3_referer/bucket_referer_setting_14.png" alt="" /></p>

<p>이번엔 타인의 <code class="highlighter-rouge">AWS CLI</code>를 이용하여 해당 버킷에 접근할 수 있는지 확인 해 보았다.</p>

<p>역시나 <code class="highlighter-rouge">AccessDenied</code>가 나오므로, 설정이 정상적으로 적용된 것을 확인할 수 있다.</p>

<p><img src="/images/pen-testing/cloud/s3_referer/bucket_referer_setting_15.png" alt="" /></p>
</section>
  
<footer>
  <div class="tags">
    
    <a class="tag" href="/tags#Cloud">#Cloud</a>
    
    <a class="tag" href="/tags#pen-testing">#pen-testing</a>
    
  </div>
</footer>


</article>
<!-- Disqus -->
<a href="https://mingzz1.github.io/pentesting/cloud/2020/04/05/aws_s3_access_control_with_referer.html#disqus_thread"></a>

<div class="comments">
    
<div id="disqus_thread"></div>
<script type="text/javascript">
	var disqus_shortname = 'mingzzis-blog';
	(function() {
		var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
		dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
		(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	})();
</script>
<noscript>Please enable JavaScript to view comments.</noscript>

</div>


<!-- Post navigation -->

  <div id="post-nav">
  
  <div id="previous-post" class="post-nav-post">
      <p>Previous post</p>
      <a href="/development/secure%20coding/2020/03/29/sonarqube-install_and_testing.html">
        [Secure Coding] SonarQube 설치 및 사용법
      </a>
  </div>
  
  
  <div id="next-post" class="post-nav-post">
      <p>Next post</p>
      <a href="/pentesting/web/2020/04/05/apache_hide_server_version.html">
        [Apache2] 서버 버전 정보 노출 숨기기
      </a>
  </div>
  
</div>



    </div>
    <!-- Social icons from Font Awesome, if enabled  -->

<ul class='social'>
	

	
	<li>
		<a href="mailto:mingzzi87@gmail.com" title="Email">
			<i class="fa fa-fw fa-envelope"></i>
		</a>
	</li>
	

	

	

	

	

	

	
	<li>
		<a href="https://github.com/mingzz1" title="Follow on GitHub">
			<i class="fa fa-fw fa-github"></i>
		</a>
	</li>
	

	

	

	
	<li>
		<a href="https://www.linkedin.com/in/minji-kim-12986a145/" title="Follow on LinkedIn">
			<i class="fa fa-fw fa-linkedin"></i>
		</a>
	</li>
	

	

	

	

	

	

	

	

	

	

	
</ul>


<script src="/assets/js/katex_init.js"></script>



<footer class="site-footer">
	<p class="text">Powered by <a href="https://jekyllrb.com/">Jekyll</a> with <a href="https://github.com/rohanchandra/type-theme">Type Theme</a>
</p>
</footer>


    <script id="dsq-count-scr" src="//.disqus.com/count.js" async></script>

    <!-- Google Analytics Tracking code -->
<script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', '']);
    _gaq.push(['_trackPageview']);
    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
</script>

  </body>
</html>
